#!/bin/bash
#######################################################################################################################
#                                            _                                   _                                    #
#                                     |     | |                                 | |                                   #
#                                   __|   _ | |          __,   __   __   _  _   | |                                   #
#                                  /  |  |/ |/ \_|   |  /  |  /    /  \_/ |/ |  |/                                    #
#                                  \_/|_/|__/\_/  \_/|_/\_/|/o\___/\__/   |  |_/|__/                                  #
#                                                   /|                    |\                                          #
#                                                   \|                    |/                                          #
#######################################################################################################################
#
# 文件位置: /etc/logstash/conf.d/debug.conf
# 文件说明:
#     •  当前管道配置文件用于软件调试, 使用 $ /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/debug.conf
#     •  当前管道配置文件支持下述三种输入格式:
#         •  2022-02-22 20:22:02.222 ERROR [feature.core.input] demo string
#         •  2022-02-22 20:22:02.222 demo string
#         •  demo string
#     •  当前管道配置文件在时间戳上使用有多种转换格式, 其中:
#         •  日志事件中的 @timestamp 字段固定使用 TIMESTAMP_ISO8601 格式输出格林尼治时间戳
#         •  filter.grok.match.message 配置项的时间戳转换语法见 
#         •  filter.date.match 配置项的时间戳转换语法见
#


# =====================================================================================================================
# 输入配置部分
# =====================================================================================================================
input {
    stdin {}
}


# =====================================================================================================================
# 过滤配置部分
# =====================================================================================================================
filter {
    grok {
        match => {
            "message" => [
                "(?<timestamp>%{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND}\.\d{3}) %{LOGLEVEL:level} \[%{DATA:feature}\] (?<body>.*$)",
                "(?<timestamp>%{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND}\.\d{3}) (?<body>.*$)",
                "(?<body>.*$)"
            ]
        }
    }
    if [timestamp] != "" {
        date {
            match => ["timestamp", "yyyy-MM-dd HH:mm:ss.SSS"]
        }
    }
    ruby {
        code => "event.set('timestamp', event.get('@timestamp').time.localtime + 8*60*60)"
    }
    ruby {
        code => "event.set('@timestamp', event.get('timestamp'))"
    }
    mutate {
        remove_field => ["tags", "host", "@version"]
    }
}


# =====================================================================================================================
# 输出配置部分
# =====================================================================================================================
output {
    if [message] =~ "[a-zA-Z0-9]+" {
        stdout {
            codec => "rubydebug"
        }
    } else {}
}
